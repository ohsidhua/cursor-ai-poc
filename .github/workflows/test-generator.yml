name: üß™ Auto Test Generator

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      target_class:
        description: 'Specific class to generate tests for (optional)'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-tests:
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'pull_request' && github.event.label.name == 'generate-tests')
    
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version
          
      - name: üîç Find Classes Without Tests
        id: find-classes
        shell: bash
        run: |
          echo "Scanning for classes without tests..."
          
          if [ ! -d "force-app" ]; then
            echo "‚ö†Ô∏è  force-app directory not found"
            echo "has_missing_tests=false" >> $GITHUB_OUTPUT
            echo "classes<<EOF" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CLASSES_WITHOUT_TESTS=""
          
          # Find all Apex classes (excluding test classes)
          while IFS= read -r -d '' class_file; do
            if [ -z "$class_file" ]; then
              continue
            fi
            class_name=$(basename "$class_file" .cls)
            test_file="${class_file%/*}/${class_name}Test.cls"
            
            if [ ! -f "$test_file" ]; then
              CLASSES_WITHOUT_TESTS="${CLASSES_WITHOUT_TESTS}${class_file}"$'\n'
              echo "‚ùå Missing test: $class_name"
            else
              echo "‚úÖ Has test: $class_name"
            fi
          done < <(find force-app -name "*.cls" ! -name "*Test.cls" -type f -print0 2>/dev/null || true)
          
          echo "classes<<EOF" >> $GITHUB_OUTPUT
          printf "%s" "$CLASSES_WITHOUT_TESTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -z "$CLASSES_WITHOUT_TESTS" ]; then
            echo "has_missing_tests=false" >> $GITHUB_OUTPUT
          else
            echo "has_missing_tests=true" >> $GITHUB_OUTPUT
          fi
          
      - name: üîß Install jq (for JSON parsing)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: ü§ñ Generate Test Classes
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          echo "ü§ñ Generating test classes with AI..."
          
          CLASSES="${{ steps.find-classes.outputs.classes }}"
          GENERATED_COUNT=0
          
          # Process classes without using pipe to avoid subshell
          while IFS= read -r class_file; do
            if [ -z "$class_file" ] || [ ! -f "$class_file" ]; then
              continue
            fi
            
            class_name=$(basename "$class_file" .cls)
            test_file="${class_file%/*}/${class_name}Test.cls"
            test_meta="${class_file%/*}/${class_name}Test.cls-meta.xml"
            
            echo "Generating test for: $class_name"
            
            if [ ! -f "$class_file" ]; then
              echo "‚ö†Ô∏è  Class file not found: $class_file"
              continue
            fi
            
            CLASS_CONTENT=$(cat "$class_file")
            
            if [ -z "$CLASS_CONTENT" ]; then
              echo "‚ö†Ô∏è  Empty class file: $class_file"
              continue
            fi
            
            # Create comprehensive test generation prompt
            TEST_PROMPT="You are an expert Salesforce test developer. Generate a comprehensive Apex test class for the following Salesforce class.

CLASS TO TEST: $class_name

SOURCE CODE:
\`\`\`apex
$CLASS_CONTENT
\`\`\`

REQUIREMENTS:
1. Test class name must be exactly: ${class_name}Test
2. Use @isTest annotation at class level
3. Include @TestSetup method to create test data if needed
4. Cover ALL public and global methods
5. Include positive test scenarios
6. Include negative test scenarios (error handling)
7. Include bulk test scenarios (200 records)
8. Use Test.startTest() and Test.stopTest() appropriately
9. Use System.assert, System.assertEquals with descriptive messages
10. Mock any external callouts using Test.setMock()
11. Aim for 100% code coverage
12. Follow Salesforce best practices
13. Add JSDoc comments explaining each test method

OUTPUT FORMAT:
- Provide ONLY the complete Apex test class code
- No explanations or markdown formatting
- Start with /** class comment */ and end with final }
- Include all necessary imports and annotations"

            # Escape prompt for JSON
            if ! ESCAPED_PROMPT=$(echo "$TEST_PROMPT" | jq -Rs .); then
              echo "‚ùå Failed to escape prompt for $class_name"
              continue
            fi
            
            # Generate test class using OpenAI API
            if [ -z "$OPENAI_API_KEY" ]; then
              echo "‚ùå OPENAI_API_KEY is not set"
              exit 1
            fi
            
            RESPONSE=$(curl -s -w "\n%{http_code}" https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4\",
                \"messages\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"You are an expert Salesforce test developer. Generate complete, production-ready Apex test classes.\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": $ESCAPED_PROMPT
                  }
                ],
                \"temperature\": 0.2,
                \"max_tokens\": 4000
              }")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "‚ùå API call failed with HTTP $HTTP_CODE for $class_name"
              echo "Response: $RESPONSE_BODY"
              continue
            fi
            
            # Extract test class code
            TEST_CODE=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content // ""')
            
            if [ -z "$TEST_CODE" ]; then
              echo "‚ùå No test code generated for $class_name"
              continue
            fi
            
            # Clean up markdown code blocks if present
            if echo "$TEST_CODE" | grep -q '```apex'; then
              TEST_CODE=$(echo "$TEST_CODE" | sed -n '/```apex/,/```/p' | sed '1d;$d')
            elif echo "$TEST_CODE" | grep -q '```'; then
              TEST_CODE=$(echo "$TEST_CODE" | sed -n '/```/,/```/p' | sed '1d;$d')
            fi
            
            # Remove leading/trailing whitespace
            TEST_CODE=$(echo "$TEST_CODE" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            if [ -z "$TEST_CODE" ]; then
              echo "‚ùå Test code is empty after cleanup for $class_name"
              continue
            fi
            
            echo "$TEST_CODE" > "$test_file"
            
            # Verify the file was created and has content
            if [ -s "$test_file" ]; then
              # Create meta.xml file
              cat > "$test_meta" << 'METAXML'
<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>60.0</apiVersion>
    <status>Active</status>
</ApexClass>
METAXML
              
              echo "‚úÖ Generated: $test_file"
              GENERATED_COUNT=$((GENERATED_COUNT + 1))
            else
              echo "‚ùå Failed to generate: $test_file"
              rm -f "$test_file"
            fi
          done <<< "$CLASSES"
          
          echo "GENERATED_COUNT=$GENERATED_COUNT" >> $GITHUB_ENV
          echo "Generated $GENERATED_COUNT test classes"
          
      - name: üîç Validate Generated Tests
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        shell: bash
        run: |
          echo "üîç Validating generated test classes..."
          
          # Check syntax of generated tests
          while IFS= read -r -d '' test_file; do
            if [ -f "$test_file" ]; then
              # Basic validation - check for required elements
              if grep -q "@isTest" "$test_file" && grep -q "class" "$test_file"; then
                echo "‚úÖ Valid syntax: $(basename "$test_file")"
              else
                echo "‚ö†Ô∏è  Potential issues: $(basename "$test_file")"
              fi
            fi
          done < <(find force-app -name "*Test.cls" -type f -print0)
          
      - name: üìä Generate Test Report
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        shell: bash
        run: |
          GENERATED_COUNT="${{ env.GENERATED_COUNT }}"
          GENERATED_COUNT=${GENERATED_COUNT:-0}
          
          cat > test-generation-report.md << EOF
# üß™ Test Generation Report

## Summary
- **Tests Generated**: $GENERATED_COUNT
- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
- **Triggered By**: ${{ github.actor }}

## Generated Test Classes

EOF
          
          # Find recently created test files (created in last hour)
          TEST_FILES_FOUND=0
          while IFS= read -r -d '' test_file; do
            if [ -f "$test_file" ]; then
              test_name=$(basename "$test_file" .cls)
              lines=$(wc -l < "$test_file" 2>/dev/null || echo "0")
              echo "- ‚úÖ \`$test_name\` ($lines lines)" >> test-generation-report.md
              TEST_FILES_FOUND=$((TEST_FILES_FOUND + 1))
            fi
          done < <(find force-app -name "*Test.cls" -type f -print0)
          
          if [ $TEST_FILES_FOUND -eq 0 ]; then
            echo "- No new test files found" >> test-generation-report.md
          fi
          
          cat >> test-generation-report.md << 'EOF'

## Next Steps

1. **Review Generated Tests**: Carefully review each generated test class
2. **Validate Logic**: Ensure test assertions match expected behavior
3. **Run Tests**: Execute tests in your Salesforce org
4. **Check Coverage**: Verify code coverage meets requirements (85%+)
5. **Refine**: Adjust tests as needed for your specific use cases

## Important Notes

‚ö†Ô∏è **AI-generated tests should always be reviewed by a human before deployment**
- Verify test data setup is appropriate
- Ensure assertions validate correct behavior
- Check for any security or privacy concerns
- Validate bulk processing scenarios

---
*ü§ñ Generated by AI Test Generator - Powered by OpenAI GPT-4*
EOF
          
      - name: üíæ Commit Generated Tests
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        shell: bash
        run: |
          git config user.name "Cursor AI Bot"
          git config user.email "cursor-ai@github-actions"
          
          # Check if there are any test files to add
          if find force-app -name "*Test.cls" -type f 2>/dev/null | grep -q .; then
            git add force-app/**/*Test.cls* 2>/dev/null || true
          fi
          
          if [ -f "test-generation-report.md" ]; then
            git add test-generation-report.md
          fi
          
          if git diff --staged --quiet; then
            echo "No tests to commit"
          else
            GENERATED_COUNT="${{ env.GENERATED_COUNT }}"
            GENERATED_COUNT=${GENERATED_COUNT:-0}
            
            git commit -m "ü§ñ Auto-generate test classes via AI

Generated ${GENERATED_COUNT} test classes
            
Co-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
            
            git push || echo "‚ö†Ô∏è  Push failed (may need manual push)"
            echo "‚úÖ Tests committed and pushed"
          fi
          
      - name: üí¨ Post Results Comment
        if: always() && (github.event_name == 'pull_request')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = '';
            
            if (fs.existsSync('test-generation-report.md')) {
              comment = fs.readFileSync('test-generation-report.md', 'utf8');
            } else if ('${{ steps.find-classes.outputs.has_missing_tests }}' === 'false') {
              comment = '‚úÖ **All classes already have test coverage!**\n\nNo test generation needed.';
            } else {
              comment = '‚ùå **Test generation failed**\n\nPlease check the workflow logs for details.';
            }
            
            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            if (prNumber) {
              github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
            
      - name: üì§ Upload Artifacts
        if: always() && steps.find-classes.outputs.has_missing_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: |
            force-app/**/*Test.cls
            force-app/**/*Test.cls-meta.xml
            test-generation-report.md
          retention-days: 30
          if-no-files-found: ignore


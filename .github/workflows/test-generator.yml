name: üß™ Auto Test Generator

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      target_class:
        description: 'Specific class to generate tests for (optional)'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-tests:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.label.name == 'generate-tests')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: üîç Find Classes Without Tests
        id: find-classes
        run: |
          echo "Scanning for classes without tests..."
          CLASSES_WITHOUT_TESTS=""

          # Find all Apex classes (excluding test classes)
          while IFS= read -r class_file; do
            class_name=$(basename "$class_file" .cls)
            test_file="${class_file%/*}/${class_name}Test.cls"

            if [ ! -f "$test_file" ]; then
              CLASSES_WITHOUT_TESTS="${CLASSES_WITHOUT_TESTS}${class_file}\n"
              echo "‚ùå Missing test: $class_name"
            else
              echo "‚úÖ Has test: $class_name"
            fi
          done < <(find force-app -name "*.cls" ! -name "*Test.cls" -type f)

          echo "classes<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$CLASSES_WITHOUT_TESTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          if [ -z "$CLASSES_WITHOUT_TESTS" ]; then
            echo "has_missing_tests=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_missing_tests=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üîß Install jq (for JSON parsing)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: ü§ñ Generate Test Classes
        if: ${{ steps.find-classes.outputs.has_missing_tests == 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ü§ñ Generating test classes with AI..."

          CLASSES=$(echo "${{ steps.find-classes.outputs.classes }}" | tr -d '\r')
          GENERATED_COUNT=0

          while IFS= read -r class_file; do
            if [ -z "$class_file" ] || [ ! -f "$class_file" ]; then
              continue
            fi

            class_name=$(basename "$class_file" .cls)
            test_file="${class_file%/*}/${class_name}Test.cls"
            test_meta="${class_file%/*}/${class_name}Test.cls-meta.xml"

            echo "Generating test for: $class_name"
            CLASS_CONTENT=$(cat "$class_file")

            TEST_PROMPT=$(cat <<EOF
You are an expert Salesforce test developer. Generate a comprehensive Apex test class for the following Salesforce class.

CLASS TO TEST: $class_name

SOURCE CODE:
\`\`\`apex
$CLASS_CONTENT
\`\`\`

REQUIREMENTS:
1. Test class name must be exactly: ${class_name}Test
2. Use @isTest annotation at class level
3. Include @TestSetup method to create test data if needed
4. Cover ALL public and global methods
5. Include positive, negative, and bulk (200 records) scenarios
6. Use Test.startTest() and Test.stopTest()
7. Use System.assert/System.assertEquals with descriptive messages
8. Mock callouts using Test.setMock() if needed
9. Aim for 100% coverage and Salesforce best practices
10. Output ONLY the Apex test class (no markdown, no explanation)
EOF
)

            ESCAPED_PROMPT=$(echo "$TEST_PROMPT" | jq -Rs .)

            RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4o-mini\",
                \"messages\": [
                  {\"role\": \"system\", \"content\": \"You are an expert Salesforce test developer.\"},
                  {\"role\": \"user\", \"content\": $ESCAPED_PROMPT}
                ],
                \"temperature\": 0.2,
                \"max_tokens\": 4000
              }")

            TEST_CODE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // ""')

            # Clean markdown code fences if present
            TEST_CODE=$(echo "$TEST_CODE" | sed '/^```/d')

            echo "$TEST_CODE" > "$test_file"

            if [ -s "$test_file" ] && grep -q "@isTest" "$test_file"; then
              cat > "$test_meta" << 'METAXML'
<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
  <apiVersion>60.0</apiVersion>
  <status>Active</status>
</ApexClass>
METAXML
              echo "‚úÖ Generated: $test_file"
              GENERATED_COUNT=$((GENERATED_COUNT + 1))
            else
              echo "‚ùå Failed to generate: $test_file"
              rm -f "$test_file" "$test_meta"
            fi
          done <<< "$(echo -e "$CLASSES")"

          echo "GENERATED_COUNT=$GENERATED_COUNT" >> "$GITHUB_ENV"

      - name: üîç Validate Generated Tests
        if: ${{ steps.find-classes.outputs.has_missing_tests == 'true' }}
        run: |
          echo "üîç Validating generated test classes..."
          find force-app -name "*Test.cls" -type f | while read -r test_file; do
            if grep -q "@isTest" "$test_file"; then
              echo "‚úÖ Valid syntax: $(basename "$test_file")"
            else
              echo "‚ö†Ô∏è  Potential issue: $(basename "$test_file")"
            fi
          done

      - name: üìä Generate Test Report
        if: ${{ steps.find-classes.outputs.has_missing_tests == 'true' }}
        run: |
          {
            echo "# üß™ Test Generation Report"
            echo ""
            echo "## Summary"
            echo "- **Tests Generated**: ${{ env.GENERATED_COUNT }}"
            echo "- **Timestamp**: $(date)"
            echo "- **Triggered By**: ${{ github.actor }}"
            echo ""
            echo "## Generated Test Classes"
            echo ""
          } > test-generation-report.md

          find force-app -name "*Test.cls" -type f | while read -r test_file; do
            test_name=$(basename "$test_file" .cls)
            lines=$(wc -l < "$test_file")
            echo "- ‚úÖ \`$test_name\` ($lines lines)" >> test-generation-report.md
          done

          cat >> test-generation-report.md << 'EOF'

## Next Steps
1. Review generated tests carefully.
2. Run and validate tests in Salesforce.
3. Ensure assertions match expected logic.
4. Adjust for org-specific logic as needed.

‚ö†Ô∏è **AI-generated tests must be reviewed before deployment**

---
ü§ñ *Generated by AI Test Generator - Powered by OpenAI GPT-4o-mini*
EOF

      - name: üíæ Commit Generated Tests
        if: ${{ steps.find-classes.outputs.has_missing_tests == 'true' }}
        run: |
          git config user.name "Cursor AI Bot"
          git config user.email "cursor-ai@github-actions"

          git add force-app/**/*Test.cls* test-generation-report.md || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ü§ñ Auto-generate test classes via AI

Generated ${{ env.GENERATED_COUNT }} test classes

Co-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
            git push
          fi

      - name: üí¨ Post Results Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '';
            if (fs.existsSync('test-generation-report.md')) {
              body = fs.readFileSync('test-generation-report.md', 'utf8');
            } else {
              body = '‚úÖ **All classes already have test coverage!**';
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: üì§ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: |
            force-app/**/*Test.cls
            test-generation-report.md
          retention-days: 30
